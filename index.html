<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IoT Dashboard</title>

  <!-- Bootstrap + Chart.js -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <!-- Custom CSS -->
  <link rel="stylesheet" href="style.css">

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- Favicon -->
  <link rel="icon" href="icons/icon-192x192.png" type="image/png">
</head>

<body>
  <!-- Redirect if not logged in -->
  <script>
    if (localStorage.getItem('loggedIn') !== 'true') {
      window.location.href = 'login.html';
    }
  </script>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Medisafe</a>
      <div class="form-check form-switch text-light ms-auto">
        <input class="form-check-input" type="checkbox" id="darkModeToggle">
        <label class="form-check-label" for="darkModeToggle">Dark Mode</label>
      </div>
      <!-- Authentication Button -->
      <button class="btn btn-warning btn-sm ms-3" id="authBtn">Authentication</button>
      <button class="btn btn-danger btn-sm ms-3" id="logoutBtn">Logout</button>
    </div>
  </nav>

  <div class="container mt-4">
    <div id="widgetContainer" class="row">
      <!-- Threshold Settings -->
      <div class="col-md-12 mb-3 widget">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title">Custom Threshold Settings</h5>
            <div class="row g-3">
              <div class="col-md-4">
                <label for="tempThreshold" class="form-label">Temperature Max (°C)</label>
                <input type="number" id="tempThreshold" class="form-control" value="28">
              </div>
              <div class="col-md-4">
                <label for="humidityThreshold" class="form-label">Humidity Max (%)</label>
                <input type="number" id="humidityThreshold" class="form-control" value="80">
              </div>
              <div class="col-md-4">
                <label for="vibrationThreshold" class="form-label">Vibration Max (g)</label>
                <input type="number" id="vibrationThreshold" class="form-control" value="2">
              </div>
            </div>
            <button class="btn btn-success mt-3" id="saveThresholdsBtn">Save Thresholds</button>
          </div>
        </div>
      </div>

      <!-- Gauges -->
      <div class="col-md-4 mb-3">
        <div class="card shadow-sm text-center">
          <div class="card-body">
            <h5 class="card-title">Temperature</h5>
            <canvas id="temperatureGauge"></canvas>
          </div>
        </div>
      </div>
      <div class="col-md-4 mb-3">
        <div class="card shadow-sm text-center">
          <div class="card-body">
            <h5 class="card-title">Humidity</h5>
            <canvas id="humidityGauge"></canvas>
          </div>
        </div>
      </div>
      <div class="col-md-4 mb-3">
        <div class="card shadow-sm text-center">
          <div class="card-body">
            <h5 class="card-title">Vibration</h5>
            <canvas id="vibrationGauge"></canvas>
          </div>
        </div>
      </div>

      <!-- Alerts -->
      <div class="col-md-6 mb-3">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title">System Alerts</h5>
            <div id="alerts" class="alert-container">No Alerts Yet</div>
          </div>
        </div>
      </div>

      <!-- Map -->
      <div class="col-md-6 mb-3 widget" id="widget-map">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title">Device Location</h5>
            <div id="map" style="height: 300px;">Loading Map...</div>
          </div>
        </div>
      </div>

      <!-- Historical Chart -->
      <div class="col-md-6 mb-3">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title">Historical Data Trends</h5>
            <canvas id="dataChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- QR Scan / Upload Modal -->
  <div class="modal fade" id="qrAuthModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Scan QR / Upload Image</h5>
        </div>
        <div class="modal-body text-center">
          <button class="btn btn-primary mb-2" id="startScanBtn">Start Camera Scan</button>
          <input type="file" id="uploadQr" accept="image/*" class="form-control mb-2">
          <div class="video-wrapper mt-2 position-relative">
            <video id="qrVideo" autoplay muted playsinline style="width:100%; display:none;"></video>
            <div id="scanOverlay"
              style="position:absolute; border:3px solid red; width:200px; height:200px; top:50%; left:50%; transform:translate(-50%,-50%); display:none;"></div>
          </div>
          <canvas id="qrCanvas" class="d-none"></canvas>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Authentication Modal -->
  <div class="modal fade" id="authModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title">Authenticate</h5>
        </div>
        <div class="modal-body">
          <form id="authForm">
            <div class="mb-3">
              <input type="text" id="authUsername" class="form-control" placeholder="Username" required>
            </div>
            <div class="mb-3">
              <input type="password" id="authPassword" class="form-control" placeholder="Password" required>
            </div>
            <div id="authMsg" class="small text-danger d-none"></div>
            <button type="submit" class="btn btn-primary">Login</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Cooling System Modal -->
  <div class="modal fade" id="coolingSystemModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">⚠️ Cooling System Activated</h5>
        </div>
        <div class="modal-body">
          <p id="coolingMessage">Sensor exceeded threshold! Activating cooling system...</p>
          <div class="progress my-3">
            <div id="coolingProgress" class="progress-bar progress-bar-striped progress-bar-animated bg-info"></div>
          </div>
          <p>Cooling down... Please wait.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
  <script src="app.js"></script>

  <script>
    // QR & Authentication Logic
    const authBtn = document.getElementById('authBtn');
    const qrAuthModalEl = document.getElementById('qrAuthModal');
    const qrModal = new bootstrap.Modal(qrAuthModalEl);
    const authModalEl = document.getElementById('authModal');
    const authModal = new bootstrap.Modal(authModalEl);

    const qrVideo = document.getElementById('qrVideo');
    const qrCanvas = document.getElementById('qrCanvas');
    const scanOverlay = document.getElementById('scanOverlay');
    const uploadQr = document.getElementById('uploadQr');
    const startScanBtn = document.getElementById('startScanBtn');

    let qrStream = null;
    let scanning = false;

    authBtn.addEventListener('click', () => {
      qrModal.show();
    });

    startScanBtn.addEventListener('click', async () => {
      try {
        qrStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        qrVideo.srcObject = qrStream;
        qrVideo.style.display = 'block';
        scanOverlay.style.display = 'block';
        await qrVideo.play();
        scanning = true;
        scanLoop();
      } catch (e) {
        alert("❌ Camera not available");
      }
    });

    function stopScanner() {
      scanning = false;
      if (qrVideo.srcObject) qrVideo.srcObject.getTracks().forEach(t => t.stop());
      qrVideo.srcObject = null;
      qrVideo.style.display = 'none';
      scanOverlay.style.display = 'none';
    }

    function scanLoop() {
      if (!scanning) return;
      const ctx = qrCanvas.getContext('2d');
      qrCanvas.width = qrVideo.videoWidth;
      qrCanvas.height = qrVideo.videoHeight;
      ctx.drawImage(qrVideo, 0, 0, qrCanvas.width, qrCanvas.height);
      const boxSize = 200;
      const sx = (qrCanvas.width - boxSize) / 2;
      const sy = (qrCanvas.height - boxSize) / 2;
      const img = ctx.getImageData(sx, sy, boxSize, boxSize);
      const code = jsQR(img.data, img.width, img.height);
      if (code) {
        stopScanner();
        qrModal.hide();
        authModal.show();
      } else {
        requestAnimationFrame(scanLoop);
      }
    }

    uploadQr.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        stopScanner();
        qrModal.hide();
        authModal.show();
      }
    });

    const authForm = document.getElementById('authForm');
    const authUsername = document.getElementById('authUsername');
    const authPassword = document.getElementById('authPassword');
    const authMsg = document.getElementById('authMsg');

    authForm.addEventListener('submit', (e) => {
      e.preventDefault();
      if (authUsername.value === "driver" && authPassword.value === "letmein") {
        authMsg.classList.add('d-none');
        authModal.hide();
        alert("✅ Authentication Successful!");
      } else {
        authMsg.textContent = "❌ Invalid credentials";
        authMsg.classList.remove('d-none');
      }
    });

    qrAuthModalEl.addEventListener('hidden.bs.modal', stopScanner);
  </script>
</body>
</html>
